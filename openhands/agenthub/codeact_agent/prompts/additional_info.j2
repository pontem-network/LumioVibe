{% if runtime_info -%}
<RUNTIME_INFORMATION>
{% if runtime_info.working_dir %}
Working directory: {{ runtime_info.working_dir }}
{% endif %}
{% if runtime_info.available_hosts %}
Available hosts for web apps:
{% for host, port in runtime_info.available_hosts.items() -%}
* {{ host }} (port {{ port }})
{% endfor %}
Use these ports for dev servers. Set server.host=true for Vite.
{% endif %}

<LUMIO_VIBE_RUNTIME>
⚠️ LUMIO/MOVE PROJECT SETUP ⚠️

**Start with:** `bash /openhands/templates/scaffold-fast.sh PROJECT_NAME`

This creates everything: account, funding, contract template, frontend template.

❌ NEVER: `lumio init` manually, create Move.toml manually
✅ Config location: /workspace/.lumio/config.yaml

---

⛔ **MANDATORY: USE TodoWrite FOR ALL PHASES!** ⛔

**You MUST use TodoWrite to track tasks throughout the workflow!**

**Create tasks at start of each phase:**
- Phase 1: Setup tasks (scaffold, verify structure)
- Phase 2: Contract tasks (implement each function, compile, test)
- Phase 4: Frontend tasks (each file to customize)
- Phase 4.4: Data refresh verification tasks
- Phase 4.5: Browser test tasks (FROM spec.md - 1 task per function!)

**Example for browser testing (Phase 4.5):**
```
TodoWrite: [
  {"content": "Test initialize() - verify status changes", "status": "pending", "activeForm": "Testing initialize()"},
  {"content": "Test stake() - verify balance updates", "status": "pending", "activeForm": "Testing stake()"},
  // ... one task per function from spec.md
  {"content": "Test edge case: zero input", "status": "pending", "activeForm": "Testing zero input"},
  {"content": "Create Browser Test Report", "status": "pending", "activeForm": "Creating test report"}
]
```

**⛔ Mark task "in_progress" BEFORE starting, "completed" AFTER passing!**
**⛔ NEVER have 0 tasks - always track what you're doing!**

---

**Pre-installed (DO NOT install):**
* lumio CLI v7.8.0: /openhands/bin/lumio
* Node.js v22+, pnpm, TypeScript, Vite

**Lumio Network (CRITICAL):**
* Chain ID: **2** (NOT 1 or 4!)
* RPC: **https://api.testnet.lumio.io/v1**
* Native Coin: `0x1::lumio_coin::LumioCoin` (NOT AptosCoin!)

---

⛔ **NO MOCK DATA IN FRONTEND** ⛔

ALL data MUST come from blockchain!

❌ FORBIDDEN:
```typescript
setBalance(1000000000);  // hardcoded
// Mock data for now...
console.log(`Action`);   // no contract call
```

✅ CORRECT:
```typescript
const balance = await callView('get_balance', [account]);
setBalance(balance);

const result = await callEntry('stake', [amount]);
if (result) await refreshData();
```

**FOUR FILES MUST BE CUSTOMIZED (not template defaults!):**
- `contract/sources/contract.move` - RENAME module from `counter` to YOUR module name!
- `useContract.ts` - MODULE_NAME must match your contract module!
- `Documentation.tsx` - YOUR contract functions (not counter!)
- `Home.tsx` - YOUR contract UI

**If data doesn't change after TX = MOCK DATA = FIX IT!**

---

⛔ **UNIT TESTS BEFORE DEPLOY/BROWSER** ⛔

**Move Tests (Phase 2.2):**
```bash
cd contract && lumio move test --package-dir .
```
- Edit `contract_tests.move` for YOUR contract
- ALL tests must pass before deploy!

**Frontend Tests (Phase 4.2):**
```bash
cd frontend && pnpm test
```
- Use `toChainUnits`/`toHumanUnits` from `src/utils/decimals.ts`
- Add contract-specific tests to `decimals.test.ts`

---

⛔ **DECIMALS: USE UTILITIES!** ⛔

```typescript
// ❌ WRONG - double conversion:
const stake = (a) => callEntry('stake', [(a*1e8).toString()]); // hook converts
await stake(parseFloat(input) * 1e8);  // handler ALSO converts!

// ✅ CORRECT - convert in ONE place only!
```

---

⛔ **PORT MANAGEMENT - CRITICAL!** ⛔

**ALWAYS use npm scripts (not raw vite commands!):**
```bash
pnpm start:prod   # Production on $APP_PORT_1
pnpm start:test   # Test Mode on $APP_PORT_2
```

These scripts automatically:
1. Kill process on target port
2. Use --strictPort (won't pick random port)

❌ NEVER: `pnpm dev --host --port $APP_PORT_1` (Vite picks random port if busy!)
✅ ALWAYS: `pnpm start:prod` or `pnpm start:test`

---

⛔ **QA VERIFICATION (Phase 4.3) - MANDATORY!** ⛔

**Run verification script BEFORE browser testing:**
```bash
bash /openhands/templates/verify-integration.sh PROJECT_DIR
```

**Manual QA Checklist:**
- [ ] "Connect Wallet" button visible
- [ ] CONTRACT_ADDRESS matches deployed address
- [ ] MODULE_NAME matches contract module (NOT 'counter'!)
- [ ] ALL entry/view functions have wrappers
- [ ] Using toChainUnits/toHumanUnits (no manual 1e8!)
- [ ] Numbers display as "1.5" not "150000000"
- [ ] No "undefined" or "[object Object]" in UI

**⛔ DO NOT proceed until verification script PASSES!**

---

⛔ **DATA REFRESH VERIFICATION (Phase 4.4) - MOST CRITICAL!** ⛔

**THE #1 BUG: UI values don't update after transactions!**

**Step 1: Run data refresh script:**
```bash
bash /openhands/templates/verify-data-refresh.sh PROJECT_DIR
```

**Step 2: MANDATORY Before/After Test:**
1. Call view function via curl → record BEFORE value
2. Execute entry function via CLI
3. Call same view function → record AFTER value
4. **VALUES MUST BE DIFFERENT!**

**Step 3: Browser Data Refresh Test:**
1. Start Test Mode: `pnpm start:test`
2. Note value in UI
3. Execute action (click button)
4. **VALUE IN UI MUST CHANGE!**

**⛔ If values DON'T change = MOCK DATA BUG = FIX FIRST!**

Common fixes:
- refreshData() must call actual view functions
- Action handlers must call refreshData() after TX
- Remove hardcoded useState values

---

⛔ **AGGRESSIVE TESTING PROTOCOL** ⛔

**Philosophy: ASSUME THERE ARE BUGS - FIND THEM!**

1. **Console Clean** - NO red errors before testing!
2. **Mock Detection** - data MUST change after TX
3. **Edge Cases** - test zeros, max values, invalid inputs
4. **Error Paths** - invalid ops must be REJECTED gracefully
5. **State Consistency** - balances must add up!

**Testing Checklist:**
- [ ] Zero/empty inputs → validation error
- [ ] Over-balance amounts → "insufficient" error
- [ ] Invalid input (letters in numbers) → rejected
- [ ] Double-click → no double-submit
- [ ] Data changes after TX (not mocked!)
- [ ] Console stays clean during all tests

⛔ **AFTER ANY FIX/CHANGE:**
1. Run FULL regression (ALL tests, not just the fix!)
2. Verify fix works + nothing else broke
3. **THEN** start Production Mode on $APP_PORT_1
4. Never complete with only Test Mode running!

---

⛔ **BROWSER TEST REPORT (MANDATORY!)** ⛔

**Before Production Mode, create Browser Test Report with:**
1. ALL entry functions tested - TX hash for EACH!
2. ALL view functions tested - format verified!
3. User journeys completed - first-time, full workflow, error recovery
4. Edge cases tested - zeros, max values, invalid inputs
5. OVERALL: PASS status

**Report Template:**
```
| Function | Tested | TX Hash | UI Updated |
|----------|--------|---------|------------|
| initialize | ✅/❌ | 0x... | ✅/❌ |
| [each function] | | | |
```

**⛔ NO Production Mode without Browser Test Report showing PASS!**

---

⛔ **CONTRACT CHANGES & ABI INCOMPATIBILITY** ⛔

When modifying contract code and redeploying:

**If publish fails with "BACKWARD_INCOMPATIBLE_MODULE_UPDATE":**
```
Error: BACKWARD_INCOMPATIBLE_MODULE_UPDATE - cannot upgrade module
```

This means ABI changed incompatibly. You MUST create new account:

```bash
bash /openhands/templates/redeploy-contract.sh PROJECT_DIR
```

This script will:
1. Create new Lumio account
2. Fund it from faucet
3. Update Move.toml with new address
4. Update frontend (useContract.ts, types/index.ts)
5. Compile and deploy contract

**After redeploy:**
1. Restart frontend servers (kill old, start new)
2. Initialize contract if needed
3. Run FULL regression test
4. Start Production Mode

---

**Before finish():**
- [ ] contract.move module renamed from 'counter' to YOUR module name!
- [ ] **Move tests pass:** `lumio move test` shows all green
- [ ] useContract.ts MODULE_NAME matches contract module (NOT 'counter'!)
- [ ] **Frontend tests pass:** `pnpm test` shows all green
- [ ] Documentation.tsx describes YOUR functions (NOT counter template!)
- [ ] Using `toChainUnits`/`toHumanUnits` (no manual 1e8 conversion!)
- [ ] **⛔ QA verification PASSED:** `bash verify-integration.sh` shows green
- [ ] **⛔ Visual inspection done:** all UI elements visible, no "undefined"
- [ ] **⛔ DATA REFRESH VERIFIED (Phase 4.4):** `bash verify-data-refresh.sh` shows PASS
- [ ] **⛔ Before/After test:** values CHANGED after transaction (CLI + Browser!)
- [ ] **⛔ Browser Test Report CREATED** with evidence (TX hashes!)
- [ ] **⛔ All entry functions tested** with TX evidence
- [ ] **⛔ All view functions tested** with format verification
- [ ] **⛔ User journeys completed** (first-time, full workflow, error recovery)
- [ ] **⛔ Browser Test Report shows OVERALL: PASS**
- [ ] **⛔ Production Mode MUST BE running on $APP_PORT_1** ← USER'S APP!
- [ ] **⛔ Contract initialized for Production** (if has initialize())
- [ ] No console errors

**⛔ CRITICAL: Without $APP_PORT_1 = NO APP FOR USER = NOT COMPLETE!**
**⛔ CRITICAL: Values MUST update in UI after TX = THIS IS #1 BUG!**

**Vite HMR:** Don't restart server, just edit files!
</LUMIO_VIBE_RUNTIME>
{% if runtime_info.date %}
Date: {{ runtime_info.date }} (UTC)
{% endif %}
</RUNTIME_INFORMATION>
{% endif %}
