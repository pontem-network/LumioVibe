{% if runtime_info -%}
<RUNTIME_INFORMATION>
{% if runtime_info.working_dir %}
Working directory: {{ runtime_info.working_dir }}
{% endif %}
{% if runtime_info.available_hosts %}
Available hosts for web apps (use these URLs to access your apps!):
{% for host, port in runtime_info.available_hosts.items() -%}
* {{ host }} (binds to port {{ port }})
{% endfor %}
Use $APP_PORT_1 for dev server binding. Use $APP_BASE_URL_1 when showing URL to user!
{% endif %}

<LUMIO_VIBE_RUNTIME>
âš ï¸ LUMIO/MOVE PROJECT WORKFLOW âš ï¸

## STEP 1: Scaffold + Start Frontend (IMMEDIATE!)
```bash
bash /openhands/templates/scaffold-fast.sh PROJECT_NAME
```
This auto-creates everything AND starts frontend!

## STEP 2: Fill spec.md (BEFORE any code!)
Open `/workspace/PROJECT_NAME/spec.md` and fill ALL TODOs:
- Data Model (structs)
- Entry Functions (table)
- View Functions (table)
- User Flows

â›” NO CODE UNTIL SPEC IS COMPLETE!

## STEP 3: Update Documentation.tsx
Convert spec.md to user-facing docs page.

## STEP 4: Implement Contract
```bash
cd /workspace/PROJECT_NAME/contract
lumio move compile --package-dir .
```
â›” DO NOT DEPLOY YET!

## STEP 4.5: Contract Tests (MANDATORY!)
- Write tests for ALL entry functions from spec.md
- Write tests for ALL edge cases from spec.md
```bash
lumio move test --package-dir .
```
â›” NO DEPLOY UNTIL ALL TESTS PASS!

## STEP 5: Deploy Contract
```bash
lumio move publish --package-dir . --assume-yes
```

## STEP 6: Customize Frontend
- Update MODULE_NAME in useContract.ts
- Update Home.tsx with contract UI

## STEP 7: Browser Testing (FROM SPEC.MD!)
- Test ALL User Flows from spec.md
- Test ALL Edge Cases from spec.md
- Verify data updates after TX

## On Change Request
First determine: SPEC change or Frontend-only?
- SPEC change â†’ Update spec â†’ contract â†’ tests â†’ deploy â†’ frontend â†’ browser test
- Frontend-only â†’ Update frontend â†’ browser test

## Restart Frontend (if needed)
```bash
bash /openhands/templates/start-frontend.sh PROJECT_DIR --test
```

---

âŒ NEVER: `lumio init` manually
âœ… Config: /workspace/.lumio/config.yaml

---

**Pre-installed (DO NOT install):**
* lumio CLI v7.8.0: /openhands/bin/lumio
* Node.js v22+, pnpm, TypeScript, Vite

**Lumio Network (CRITICAL):**
* Chain ID: **2** (NOT 1 or 4!)
* RPC: **https://api.testnet.lumio.io/v1**
* Native Coin: `0x1::lumio_coin::LumioCoin` (NOT AptosCoin!)

---

â›” **NO MOCK DATA IN FRONTEND** â›”

ALL data MUST come from blockchain!

âŒ FORBIDDEN:
```typescript
setBalance(1000000000);  // hardcoded
// Mock data for now...
console.log(`Action`);   // no contract call
```

âœ… CORRECT:
```typescript
const balance = await callView('get_balance', [account]);
setBalance(balance);

const result = await callEntry('stake', [amount]);
if (result) await refreshData();
```

**FOUR FILES MUST BE CUSTOMIZED (not template defaults!):**
- `contract/sources/contract.move` - RENAME module from `counter` to YOUR module name!
- `useContract.ts` - MODULE_NAME must match your contract module!
- `Documentation.tsx` - YOUR contract functions (not counter!)
- `Home.tsx` - YOUR contract UI

**If data doesn't change after TX = MOCK DATA = FIX IT!**

---

â›” **CONTRACT TESTS = MANDATORY BEFORE DEPLOY!** â›”

**Write tests covering spec.md:**
- Test for EACH entry function
- Test for EACH edge case
- Test error conditions

```bash
cd contract && lumio move test --package-dir .
```

**Pre-deploy checkpoint:**
```
Tests: X/X passed
Entry functions tested: X/X
Edge cases tested: X/X
â›” NO DEPLOY UNTIL 100% PASS!
```

---

â›” **DECIMALS: USE UTILITIES!** â›”

```typescript
// âŒ WRONG - double conversion:
const stake = (a) => callEntry('stake', [(a*1e8).toString()]); // hook converts
await stake(parseFloat(input) * 1e8);  // handler ALSO converts!

// âœ… CORRECT - convert in ONE place only!
```

---

â›” **PORT MANAGEMENT - CRITICAL!** â›”

**ALWAYS use ./start.sh with & (background!):**
```bash
cd frontend && ./start.sh &          # Production on $APP_PORT_1
cd frontend && ./start.sh --test &   # Test Mode on $APP_PORT_1
```

The script automatically:
1. Validates $APP_PORT_1 and $APP_BASE_URL_1 are set
2. Kills process on $APP_PORT_1
3. Verifies port is free
4. Uses --strictPort (won't pick random port)
5. Passes VITE_BASE_URL to frontend (accessible via import.meta.env.VITE_BASE_URL)

**âš ï¸ URL Usage - TWO DIFFERENT CONTEXTS:**

1. **To show URL to USER (in messages):** use `$APP_BASE_URL_1`
   - This is the external URL the user can open in their browser
   - Example: "Your app is running at $APP_BASE_URL_1"

2. **For browser() tool actions (goto):** use `http://localhost:$APP_PORT_1`
   - The browser tool runs INSIDE the container
   - It can only access localhost, NOT external URLs
   - Example: `goto("http://localhost:$APP_PORT_1")`

âŒ NEVER for browser(): `goto("$APP_BASE_URL_1")` or `goto("https://...")`
âœ… ALWAYS for browser(): `goto("http://localhost:$APP_PORT_1")`

âŒ NEVER: `pnpm dev`, `pnpm start:prod`, `pnpm start:test`, `export APP_PORT_1=...`
âœ… ALWAYS: `cd frontend && ./start.sh &` (with &!)

---

â›” **QA VERIFICATION (Phase 4.3) - MANDATORY!** â›”

**Run verification script BEFORE browser testing:**
```bash
bash /openhands/templates/verify-integration.sh PROJECT_DIR
```

**Manual QA Checklist:**
- [ ] "Connect Wallet" button visible
- [ ] CONTRACT_ADDRESS matches deployed address
- [ ] MODULE_NAME matches contract module (NOT 'counter'!)
- [ ] ALL entry/view functions have wrappers
- [ ] Using toChainUnits/toHumanUnits (no manual 1e8!)
- [ ] Numbers display as "1.5" not "150000000"
- [ ] No "undefined" or "[object Object]" in UI

**â›” DO NOT proceed until verification script PASSES!**

---

â›” **DATA REFRESH VERIFICATION (Phase 4.4) - MOST CRITICAL!** â›”

**THE #1 BUG: UI values don't update after transactions!**

**Step 1: Run data refresh script:**
```bash
bash /openhands/templates/verify-data-refresh.sh PROJECT_DIR
```

**Step 2: MANDATORY Before/After Test:**
1. Call view function via curl â†’ record BEFORE value
2. Execute entry function via CLI
3. Call same view function â†’ record AFTER value
4. **VALUES MUST BE DIFFERENT!**

**Step 3: Browser Data Refresh Test:**
1. Start Test Mode: `cd frontend && ./start.sh --test`
2. Note value in UI
3. Execute action (click button)
4. **VALUE IN UI MUST CHANGE!**

**â›” If values DON'T change = MOCK DATA BUG = FIX FIRST!**

Common fixes:
- refreshData() must call actual view functions
- Action handlers must call refreshData() after TX
- Remove hardcoded useState values

---

â›” **BROWSER TESTING = FROM SPEC.MD!** â›”

**Generate tests from spec.md, not random tests!**

**Test tasks must cover:**
1. ALL User Flows from spec.md
2. ALL Edge Cases from spec.md
3. ALL Entry Functions (TX + data refresh)

**TEST EXECUTION LOOP:**
```
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“‹ TEST: [Flow/Case from spec.md]
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Action: [What you did]
Expected: [From spec.md]
Actual: [What happened]
Evidence: [TX hash / values beforeâ†’after]
Result: âœ… PASS / âŒ FAIL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

**â›” Test ALL items from spec.md!**

---

â›” **BLOCKING CHECKPOINTS** â›”

At each phase, OUTPUT checkpoint:
```
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â›” CHECKPOINT: [Phase Name]
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
[Required output]
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âœ… CHECKPOINT PASSED
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

**If you can't output checkpoint = you skipped something = GO BACK!**

---

â›” **CONTRACT CHANGES & ABI INCOMPATIBILITY** â›”

When modifying contract code and redeploying:

**If publish fails with "BACKWARD_INCOMPATIBLE_MODULE_UPDATE":**
```
Error: BACKWARD_INCOMPATIBLE_MODULE_UPDATE - cannot upgrade module
```

This means ABI changed incompatibly. You MUST create new account:

```bash
bash /openhands/templates/redeploy-contract.sh PROJECT_DIR
```

This script will:
1. Create new Lumio account
2. Fund it from faucet
3. Update Move.toml with new address
4. Update frontend (useContract.ts, types/index.ts)
5. Compile and deploy contract

**After redeploy:**
1. Restart frontend servers (kill old, start new)
2. Initialize contract if needed
3. Run FULL regression test
4. Start Production Mode

---

**Before finish() CHECKLIST:**

**Contract:**
- [ ] Module renamed from 'counter' to YOUR module
- [ ] Contract tests cover ALL entry functions from spec.md
- [ ] Contract tests cover ALL edge cases from spec.md
- [ ] `lumio move test` = 100% PASS

**Frontend:**
- [ ] MODULE_NAME matches contract (NOT 'counter'!)
- [ ] Documentation.tsx describes YOUR functions
- [ ] Home.tsx uses YOUR contract UI
- [ ] No mock data - all from blockchain

**Browser Testing (from spec.md!):**
- [ ] ALL User Flows from spec.md tested
- [ ] ALL Edge Cases from spec.md tested
- [ ] Data refresh verified after each TX
- [ ] Browser Test Report shows PASS

**Final:**
- [ ] Production Mode running on $APP_PORT_1
- [ ] Contract initialized (if needed)

---

â›” **FINAL CHECKPOINT** â›”

```
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
FINAL COMPLETION CHECKPOINT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Contract Tests: X/X PASS
User Flows (spec.md): X/X tested
Edge Cases (spec.md): X/X tested
Data Refresh: Verified âœ“
Production Mode: Running on $APP_PORT_1
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

**Vite HMR:** Don't restart server, just edit files!
</LUMIO_VIBE_RUNTIME>
{% if runtime_info.date %}
Date: {{ runtime_info.date }} (UTC)
{% endif %}
</RUNTIME_INFORMATION>
{% endif %}
